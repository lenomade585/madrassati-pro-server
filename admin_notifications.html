<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: 'Cairo', sans-serif; text-align: right; }
        .container { max-width: 600px; margin-top: 20px; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; padding: 25px; }
        
        .btn-back {
            background-color: #6c757d; color: white; text-decoration: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.9em;
            display: inline-block; margin-bottom: 15px;
        }
        .btn-back:hover { background-color: #5a6268; color: white; }

        h3 { color: #0d6efd; font-weight: 700; margin-bottom: 20px; }
        label { font-weight: 600; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <a href="admin_dashboard.html" class="btn-back">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Retour)</a>

        <div class="card shadow">
            <h3 class="text-center">ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</h3>
            
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
            <select class="form-select mb-3" id="notifType" onchange="checkTarget()">
                <option value="Fete ecole">ğŸ‰ Ø­ÙÙ„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</option>
                <option value="Reunion association">ğŸ¤ Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©</option>
                <option value="Campagne vaccin">ğŸ’‰ Ø­Ù…Ù„Ø© ØªÙ„Ù‚ÙŠØ­</option>
                <option value="Excursion">ğŸšŒ Ø±Ø­Ù„Ø© Ù…Ø¯Ø±Ø³ÙŠØ©</option>
                <option value="Rendez-vous perso">ğŸ“… Ù…ÙˆØ¹Ø¯ Ø´Ø®ØµÙŠ (Ù„ÙˆÙ„ÙŠ Ù…Ø­Ø¯Ø¯)</option>
            </select>

            <label class="form-label">Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡</label>
            <select class="form-select mb-3" id="targetSelect">
                </select>

            <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <input type="text" class="form-control mb-2" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ±">
            
            <label class="form-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <textarea class="form-control mb-3" id="message" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..."></textarea>

            <button onclick="sendNotif()" class="btn btn-primary w-100 py-2 fw-bold">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
        </div>
    </div>

    <script>
        // --- CORRECTION MAJEURE : URL DE L'API ---
        // ğŸ›‘ REMPLACEZ L'URL SUIVANTE PAR CELLE QUE RENDER VOUS DONNERA APRÃˆS DÃ‰PLOIEMENT
        const API_BASE_URL = "https://madrassati-pro-server.onrender.com";
        // Si vous travaillez en local avec le serveur Node.js, vous pouvez dÃ©commenter la ligne ci-dessous :
        // const API_BASE_URL = "http://localhost:3000"; 
        // ----------------------------------------------------------------------------------
        
        let allStudents = [];

        window.onload = async function() {
            try {
                // CORRIGÃ‰ : Utilisation de API_BASE_URL pour charger les Ã©lÃ¨ves
                const res = await fetch(`${API_BASE_URL}/api/students`);
                allStudents = await res.json();
                checkTarget();
            } catch (error) {
                console.error("Erreur chargement Ã©lÃ¨ves:", error);
                const select = document.getElementById('targetSelect');
                select.innerHTML = '<option disabled>âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</option>';
            }
        };

        function checkTarget() {
            const type = document.getElementById('notifType').value;
            const select = document.getElementById('targetSelect');
            select.innerHTML = '';

            if (type === 'Rendez-vous perso') {
                select.innerHTML = '<option selected disabled>-- Ø§Ø®ØªØ± Ø§Ù„ØªÙ„Ù…ÙŠØ° --</option>';
                if (allStudents.length > 0) {
                    allStudents.forEach(s => select.innerHTML += `<option value="${s.code}">${s.name} (${s.code})</option>`);
                } else {
                    select.innerHTML = '<option disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ø§Ù…ÙŠØ°</option>';
                }
            } else {
                select.innerHTML = '<option value="ALL">ğŸ“¢ Ù„Ù„Ø¬Ù…ÙŠØ¹ (Tout le monde)</option>';
            }
        }

        async function sendNotif() {
            const type = document.getElementById('notifType').value;
            const target = document.getElementById('targetSelect').value;
            const title = document.getElementById('title').value;
            const message = document.getElementById('message').value;

            if (!title || !message) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©");
            if (target.includes('Ø§Ø®ØªØ±') || target.includes('Ù„Ø§ ÙŠÙˆØ¬Ø¯')) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡ ou vÃ©rifier la connexion.");

            try {
                // CORRIGÃ‰ : Utilisation de API_BASE_URL pour l'envoi de la notification
                const response = await fetch(`${API_BASE_URL}/api/notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, title, message, target_id: target })
                });

                if (response.ok) {
                    alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ !");
                    document.getElementById('title').value = '';
                    document.getElementById('message').value = '';
                } else {
                    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±");
                }
            } catch (error) {
                alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            }
        }
    </script>
</body>
</html>