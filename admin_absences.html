<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background-color: #f4f6f9; 
            padding: 20px; 
            font-family: 'Cairo', sans-serif; 
            text-align: right;
        }
        .container { max-width: 600px; margin-top: 20px; }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: none;
            padding: 25px;
        }
        
        /* Bouton Retour */
        .btn-back {
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
        }
        .btn-back:hover { background-color: #5a6268; color: white; }

        .btn-submit {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            border: none;
            width: 100%;
            font-size: 1.1em;
            transition: 0.3s;
        }
        .btn-submit:hover { background-color: #bb2d3b; }
        
        label { font-weight: 600; margin-bottom: 5px; color: #555; }
        .status-indicator { font-size: 0.9em; color: #888; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <a href="admin_dashboard.html" class="btn-back">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Retour)</a>

        <div class="card">
            <h3 class="text-center" style="color:#dc3545;">â›” Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ØºÙŠØ§Ø¨</h3>
            <p class="text-center text-muted">Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„ÙˆÙ„ÙŠ</p>
            
            <div id="connectionStatus" class="status-indicator">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>

            <label>Ø§Ù„ØªÙ„Ù…ÙŠØ°</label>
            <select class="form-select mb-3" id="studentSelect">
                <option selected disabled>...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>
            </select>

            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" class="form-control mb-3" id="dateInput">

            <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
            <select class="form-select mb-4" id="reasonInput">
                <option value="ØºÙŠØ§Ø¨ ØºÙŠØ± Ù…Ø¨Ø±Ø±" selected>ğŸ”´ ØºÙŠØ§Ø¨ ØºÙŠØ± Ù…Ø¨Ø±Ø±</option>
                <option value="ØªØ£Ø®Ø±">ğŸŸ¡ ØªØ£Ø®Ø±</option>
                <option value="Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø³Ù…">âš« Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø³Ù…</option>
                <option value="Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">âš ï¸ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</option>
            </select>

            <button onclick="submitAbsence()" class="btn btn-submit">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
        </div>
    </div>

    <script>
        // --- CORRECTION MAJEURE : URL DE L'API ---
        // ğŸ›‘ REMPLACEZ L'URL SUIVANTE PAR CELLE QUE RENDER VOUS DONNERA APRÃˆS DÃ‰PLOIEMENT
        const API_BASE_URL = "https://VOTRE-URL-PUBLIQUE-DE-RENDER-ICI.com";
        // Si vous travaillez en local avec le serveur Node.js, vous pouvez dÃ©commenter la ligne ci-dessous :
        // const API_BASE_URL = "http://localhost:3000"; 
        // ----------------------------------------------------------------------------------

        window.onload = async function() {
            const select = document.getElementById('studentSelect');
            const status = document.getElementById('connectionStatus');
            document.getElementById('dateInput').valueAsDate = new Date();

            try {
                // CORRIGÃ‰ : Utilisation de API_BASE_URL
                const res = await fetch(`${API_BASE_URL}/api/students`); 
                if (!res.ok) throw new Error("Erreur serveur");
                const students = await res.json();

                status.innerHTML = 'âœ… Ù…ØªØµÙ„';
                status.style.color = 'green';
                
                select.innerHTML = '<option selected disabled>-- Ø§Ø®ØªØ± Ø§Ù„ØªÙ„Ù…ÙŠØ° --</option>';

                if (students.length > 0) {
                    students.forEach(s => {
                        // Utilisation du code de l'Ã©lÃ¨ve pour la DB
                        select.innerHTML += `<option value="${s.code}">${s.name} (${s.code})</option>`;
                    });
                } else {
                    select.innerHTML = '<option disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ø§Ù…ÙŠØ°</option>';
                }

            } catch (error) {
                console.error("Erreur:", error);
                status.innerHTML = 'âŒ Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØµÙ„';
                status.style.color = 'red';
                select.innerHTML = '<option disabled>âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</option>';
            }
        };

        async function submitAbsence() {
            const studentCode = document.getElementById('studentSelect').value;
            const date = document.getElementById('dateInput').value;
            const reason = document.getElementById('reasonInput').value;

            if (!studentCode || studentCode.includes('Ø§Ø®ØªØ±') || studentCode.includes('Ø®Ø·Ø£')) {
                return alert("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø£ÙˆÙ„Ø§Ù‹");
            }

            try {
                // CORRIGÃ‰ : Utilisation de API_BASE_URL
                const response = await fetch(`${API_BASE_URL}/api/absences`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        student_id: studentCode, 
                        date: date, 
                        reason: reason 
                    })
                });

                if (response.ok) {
                    alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ !");
                } else {
                    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±");
                }
            } catch (error) {
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„");
            }
        }
    </script>
</body>
</html>