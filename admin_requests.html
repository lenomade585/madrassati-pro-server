<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #f4f6f9; 
            padding: 20px; 
            font-family: 'Cairo', sans-serif; 
            text-align: right;
        }
        .container { max-width: 950px; margin-top: 20px; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: none; padding: 25px; }
        .btn-back { background-color: #6c757d; color: white; text-decoration: none; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; display: inline-block; }
        .btn-back:hover { background-color: #5a6268; color: white; }
        
        h3 { color: #e67e22; font-weight: 700; margin-bottom: 20px; }
        
        /* Status Badges */
        .badge-pending { background-color: #ffc107; color: #333; }
        .badge-approved { background-color: #28a745; color: white; }
        .badge-rejected { background-color: #dc3545; color: white; }
        
        .table td { vertical-align: middle; }
        .reason-text { font-size: 0.85em; color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <a href="admin_dashboard.html" class="btn-back">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Retour)</a>

        <div class="card">
            <h3 class="text-center">ğŸ“± Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‡ÙˆØ§ØªÙ</h3>
            <p class="text-center text-muted">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ (Approbation & Refus)</p>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Ø§Ù„ØªÙ„Ù…ÙŠØ°</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Actions)</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable">
                        <tr><td colspan="5" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CORRECTION MAJEURE : URL DE L'API ---
        // ğŸ›‘ REMPLACEZ L'URL SUIVANTE PAR CELLE QUE RENDER VOUS DONNERA APRÃˆS DÃ‰PLOIEMENT
        const API_BASE_URL = "https://VOTRE-URL-PUBLIQUE-DE-RENDER-ICI.com";
        // Si vous travaillez en local avec le serveur Node.js, vous pouvez dÃ©commenter la ligne ci-dessous :
        // const API_BASE_URL = "http://localhost:3000"; 
        // ----------------------------------------------------------------------------------
        
        window.onload = loadRequests;

        async function loadRequests() {
            try {
                // CORRIGÃ‰ : Utilisation de API_BASE_URL
                const res = await fetch(`${API_BASE_URL}/api/admin/requests`);
                const requests = await res.json();
                
                const tbody = document.getElementById('requestsTable');
                tbody.innerHTML = '';

                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</td></tr>';
                    return;
                }

                requests.forEach(r => {
                    let statusBadge = '';
                    let actionBtns = '';

                    // 1. En Attente
                    if (r.status === 'PENDING') {
                        statusBadge = '<span class="badge badge-pending">â³ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
                        actionBtns = `
                            <button onclick="approve(${r.student_id})" class="btn btn-success btn-sm fw-bold">âœ… Ù‚Ø¨ÙˆÙ„</button>
                            <button onclick="reject(${r.student_id})" class="btn btn-danger btn-sm fw-bold">âŒ Ø±ÙØ¶</button>
                        `;
                    } 
                    // 2. ApprouvÃ©
                    else if (r.status === 'APPROVED') {
                        statusBadge = '<span class="badge badge-approved">âœ… Ù…ÙØ¹Ù„</span>';
                        actionBtns = `<button onclick="resetDevice(${r.student_id})" class="btn btn-outline-secondary btn-sm">ğŸ—‘ï¸ Ø­Ø°Ù (Reset)</button>`;
                    } 
                    // 3. RejetÃ©
                    else if (r.status === 'REJECTED') {
                        statusBadge = `<span class="badge badge-rejected">â›” Ù…Ø±ÙÙˆØ¶</span><br><span class="reason-text">${r.message || ''}</span>`;
                        actionBtns = `
                            <button onclick="approve(${r.student_id})" class="btn btn-outline-success btn-sm">Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„</button>
                            <button onclick="resetDevice(${r.student_id})" class="btn btn-outline-secondary btn-sm">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        `;
                    }

                    let dateStr = new Date(r.request_date).toLocaleDateString('fr-FR');

                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold">${r.name}</td>
                            <td>${r.code}</td>
                            <td>${dateStr}</td>
                            <td>${statusBadge}</td>
                            <td>${actionBtns}</td>
                        </tr>
                    `;
                });
            } catch (error) { 
                console.error("Erreur de chargement des requÃªtes:", error); 
                document.getElementById('requestsTable').innerHTML = '<tr><td colspan="5" class="text-center p-4" style="color:red;">âŒ Erreur de connexion au serveur API.</td></tr>';
            }
        }

        // --- ACTION : APPROUVER ---
        async function approve(id) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) return;
            // CORRIGÃ‰ : Utilisation de API_BASE_URL
            await fetch(`${API_BASE_URL}/api/admin/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: id })
            });
            loadRequests();
        }

        // --- ACTION : REFUSER (AVEC MOTIF) ---
        async function reject(id) {
            const reason = prompt("ğŸ”´ Ù„Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŸ (Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§)");
            
            if (reason) {
                // CORRIGÃ‰ : Utilisation de API_BASE_URL
                await fetch(`${API_BASE_URL}/api/admin/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: id, reason: reason })
                });
                alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
                loadRequests();
            }
        }

        // --- ACTION : RESET ---
        async function resetDevice(id) {
            if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‡Ø§ØªÙØŸ Ø³ÙŠØªÙ…ÙƒÙ† Ø§Ù„ÙˆÙ„ÙŠ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.")) return;
            // CORRIGÃ‰ : Utilisation de API_BASE_URL
            await fetch(`${API_BASE_URL}/api/admin/reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: id })
            });
            loadRequests();
        }
    </script>
</body>
</html>