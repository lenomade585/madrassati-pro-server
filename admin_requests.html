<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #f4f6f9; 
            padding: 20px; 
            font-family: 'Cairo', sans-serif; 
            text-align: right;
        }
        .container { max-width: 950px; margin-top: 20px; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: none; padding: 25px; }
        .btn-back { background-color: #6c757d; color: white; text-decoration: none; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; display: inline-block; }
        .btn-back:hover { background-color: #5a6268; color: white; }
        
        h3 { color: #e67e22; font-weight: 700; margin-bottom: 20px; }
        
        .badge-pending { background-color: #ffc107; color: #333; }
        .badge-approved { background-color: #28a745; color: white; }
        .badge-rejected { background-color: #dc3545; color: white; }
        
        .table td { vertical-align: middle; }
        .reason-text { font-size: 0.85em; color: #dc3545; font-weight: bold; }

        /* --- STYLE DU MODAL (FenÃªtre de refus) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 10px; width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <a href="admin_dashboard.html" class="btn-back">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Retour)</a>

        <div class="card">
            <h3 class="text-center">ğŸ“± Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‡ÙˆØ§ØªÙ</h3>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Ø§Ù„ØªÙ„Ù…ÙŠØ°</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable">
                        <tr><td colspan="5" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="modal-overlay">
        <div class="modal-box">
            <h4>ğŸ”´ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</h4>
            <p>Ù„Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
            <input type="text" id="rejectReasonInput" class="form-control mb-3" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©">
            <input type="hidden" id="rejectStudentId">
            <div class="d-flex justify-content-between">
                <button onclick="closeModal()" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡ (Annuler)</button>
                <button onclick="confirmReject()" class="btn btn-danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
            </div>
        </div>
    </div>

    <script>
        // L'URL EST DÃ‰JÃ€ CORRIGÃ‰E ICI
        const API_BASE_URL = "https://madrassati-pro-server.onrender.com";
        
        window.onload = loadRequests;

        async function loadRequests() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/requests`);
                const requests = await res.json();
                
                const tbody = document.getElementById('requestsTable');
                tbody.innerHTML = '';

                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</td></tr>';
                    return;
                }

                requests.forEach(r => {
                    let statusBadge = '', actionBtns = '';

                    if (r.status === 'PENDING') {
                        statusBadge = '<span class="badge badge-pending">â³ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
                        actionBtns = `
                            <button onclick="approve(${r.student_id})" class="btn btn-success btn-sm fw-bold">âœ… Ù‚Ø¨ÙˆÙ„</button>
                            <button onclick="openRejectModal(${r.student_id})" class="btn btn-danger btn-sm fw-bold">âŒ Ø±ÙØ¶</button>
                        `;
                    } else if (r.status === 'APPROVED') {
                        statusBadge = '<span class="badge badge-approved">âœ… Ù…ÙØ¹Ù„</span>';
                        actionBtns = `<button onclick="resetDevice(${r.student_id})" class="btn btn-outline-secondary btn-sm">ğŸ—‘ï¸ Reset</button>`;
                    } else if (r.status === 'REJECTED') {
                        statusBadge = `<span class="badge badge-rejected">â›” Ù…Ø±ÙÙˆØ¶</span><br><span class="reason-text">${r.message || ''}</span>`;
                        actionBtns = `<button onclick="approve(${r.student_id})" class="btn btn-outline-success btn-sm">Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„</button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold">${r.name}</td>
                            <td>${r.code}</td>
                            <td>${new Date(r.request_date).toLocaleDateString('fr-FR')}</td>
                            <td>${statusBadge}</td>
                            <td>${actionBtns}</td>
                        </tr>
                    `;
                });
            } catch (error) { console.error("Erreur:", error); }
        }

        // --- GESTION DU MODAL (REMPLACE PROMPT) ---
        function openRejectModal(id) {
            document.getElementById('rejectStudentId').value = id;
            document.getElementById('rejectReasonInput').value = ''; // Vider le champ
            document.getElementById('rejectModal').style.display = 'flex'; // Afficher
        }

        function closeModal() {
            document.getElementById('rejectModal').style.display = 'none';
        }

        async function confirmReject() {
            const id = document.getElementById('rejectStudentId').value;
            const reason = document.getElementById('rejectReasonInput').value;

            if (!reason) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶");

            try {
                await fetch(`${API_BASE_URL}/api/admin/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: id, reason: reason })
                });
                closeModal();
                loadRequests(); // Recharger la liste
            } catch(e) { alert("Erreur connexion"); }
        }

        async function approve(id) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) return;
            await fetch(`${API_BASE_URL}/api/admin/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: id })
            });
            loadRequests();
        }

        async function resetDevice(id) {
            if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‡Ø§ØªÙØŸ")) return;
            await fetch(`${API_BASE_URL}/api/admin/reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: id })
            });
            loadRequests();
        }
    </script>
</body>
</html>